# demo-express-nosql

## Deployment
1. Clone this repository

````
sudo yum install git
git clone https://github.com/dario-vega/demo-express-nosql.git
````

2. Create the table

````
cd ~/demo-express-nosql/express-nosql
kv_admin ddl.sql
````

3. Edit and change the createClient() function if needed
4. Run

````
cd ~/demo-express-nosql/express-nosql
npm install
node express_oracle_nosql.js
````

## Deployment using docker

````
docker build -t express-nosql .
docker run -p 3000:3000  express-nosql 
````

## TEST

1. USE CURL

````
curl -X POST -d '{"id": -1, "blog": "Creating an empty blog from Node.js"}' -H 'content-type: application/json' localhost:3000
curl -X POST -d '{"blog": "Creating an empty blog from Node.js"}' -H 'content-type: application/json' localhost:3000
curl -X GET http://localhost:3000/1005
curl -X DELETE http://localhost:3000/1005
curl -X GET http://localhost:3000/
````

If you created the table using GENERATED ALWAYS AS IDENTITY instead of GENERATED BY DEFAULT AS IDENTITY, you will have the following error when trying to run the 1st command
````
curl -X POST -d '{"id": -1, "blog": "Creating an empty blog from Node.js"}' -H 'content-type: application/json' localhost:3000 |jq
  "error": {
    "_errCode": {
      "_ordinal": 4,
      "_name": "ILLEGAL_ARGUMENT",
      "retryable": false
    },
    "name": "NoSQLArgumentError",
    "_req": {
      "tableName": "BlogTable",
      "row": {
        "id": -1,
        "blog": "Creating an empty blog from Node.js"
      },
      "opt": {
        "requestTimeout": 5000
      },
      "_auth": null
    },
    "_rejectedByDriver": false
  }
}

In the console

failed to insert data NoSQLArgumentError: [ILLEGAL_ARGUMENT] PUT: Illegal Argument: Value should not be set for a generated always identity column: id

````

You can also run the following test by adding more fields to your json parameter. You will see that only the fields in the table will be used to create the record.

````
NEW=`curl -X POST -d '{"blog": "Creating an empty blog from Node.js", "completed":true}' -H 'content-type: application/json' localhost:3000 2>/dev/null | jq '.result.generatedValue'`
echo $NEW
curl  http://localhost:3000/$NEW 2>/dev/null| jq

{
  "id": 1009,
  "blog": "Creating an empty blog from Node.js"
}

````
If you don't want this behavior, set the flag exactMatch to true in the opt parameter when calling the put function (https://oracle.github.io/nosql-node-sdk/NoSQLClient.html#put)
````
const result = await client.put("BlogTable", req.body, {exactMatch:true} );


failed to insert data NoSQLArgumentError: [ILLEGAL_ARGUMENT] PUT: Illegal Argument: There is no field with name completed

````

## TEST Running generic_express_oracle_nosql.js

````
curl  http://localhost:3000/ | jq
{
  "tables": [
    "blogtable",
    "myTable",
    "People",
    "SYS$IndexStatsLease",
    "SYS$MRTableAgentStat",
    "SYS$MRTableInitCheckpoint",
    "SYS$PartitionStatsLease",
    "SYS$SGAttributesTable",
    "SYS$StreamRequest",
    "SYS$StreamResponse",
    "SYS$TableStatsIndex",
    "SYS$TableStatsPartition"
  ],
  "lastIndex": 12
}

curl  http://localhost:3000/MyTable | jq
[
  {
    "id": 0,
    "labels": [
      {
        "contentType": "Salut",
        "etag": "Salut",
        "label": "b",
        "value": "Salut"
      }
    ]
  }
]

curl  http://localhost:3000/People | jq

[
  {
    "id": 0,
    "info": {
      "address": {
        "city": "San Fransisco",
        "phones": [],
        "state": "CA"
      },
      "children": {
        "Anna": {
          "age": 10,
          "friends": [
            "Anna",
            "John",
            "Maria"
          ],
          "school": "school_1"
        },
        "Mary": {
          "age": 7,
          "friends": [
            "Anna",
            "Mark"
          ],
          "school": "school_3"
        },
        "Ron": {
          "age": 2
        }
      },
      "firstName": "John",
      "income": 200000,
      "lastName": "Doe",
      "profession": "software engineer"
    }
  }
]


curl  http://localhost:3000/People/desc | jq
{
  "tableName": "People",
  "tableState": {
    "_ordinal": 0,
    "_name": "ACTIVE"
  },
  "schema": "{\n  \"json_version\" : 1,\n  \"type\" : \"table\",\n  \"name\" : \"People\",\n  \"fields\" : [{\n    \"name\" : \"id\",\n    \"type\" : \"INTEGER\",\n    \"nullable\" : false\n  }, {\n    \"name\" : \"info\",\n    \"type\" : \"JSON\",\n    \"nullable\" : true\n  }],\n  \"primaryKey\" : [\"id\"],\n  \"shardKey\" : [\"id\"]\n}",
  "operationId": null
}

````



